@model int[,]
@{
	@* Pull game state from session for display and interaction rules. *@
	int? player2points = Context.Session.GetInt32("Player2Points");
	int? player1points = Context.Session.GetInt32("Player1Points");
	int playerTurn = Context.Session.GetInt32("PlayerNumber") ?? 0;
	int? currentPlayer = Context.Session.GetInt32("CurrentPlayer");
	bool isPlayer1Turn = false;
	bool isPlayer2Turn = false;
	string? winner = Context.Session.GetString("Winner");
	string? User1Name = Context.Session.GetString("User1Name");
	string? User2Name = Context.Session.GetString("User2Name") ?? "Waiting for Player 2";
	bool hasWinner = !string.IsNullOrEmpty(winner);
	bool isWinnerPlayer1 = hasWinner && string.Equals(winner, User1Name, StringComparison.OrdinalIgnoreCase);
	bool isWinnerPlayer2 = hasWinner && string.Equals(winner, User2Name, StringComparison.OrdinalIgnoreCase);
	bool showEndActions = hasWinner;
	@* Determine turn flags for highlighting the active player. *@
	@if (currentPlayer == 1)
	{
		isPlayer1Turn = true;
		isPlayer2Turn = false;
	}
	else if (currentPlayer == 2)
	{
		isPlayer1Turn = false;
		isPlayer2Turn = true;
	}
}


<div class="othello-wrapper board-wrapper">
	<div class="board-players">
		@{
			@* Build CSS classes for player cards based on turn and availability. *@ 
			var player1Class = $"othello-player-label othello-player1 {(isPlayer1Turn ? "player-box-active" : "")}";
			var player2Base = User2Name == null
			? "othello-player-label othello-player-waiting othello-player2"
			: "othello-player-label othello-player2";
			var player2Css = $"{player2Base} {(isPlayer2Turn ? "player-box-active" : "")}";
		}
		@if (isWinnerPlayer1)
		{
			<p class="mb-0 @player1Class winner-full">
				<span class="winner-flag">Winner!!</span>
				<span class="player-name">@User1Name</span>
				<span class="player-points-inline">• PTS: @player1points</span>
			</p>
		}
		else if (isWinnerPlayer2)
		{
			<p class="mb-0 @player2Css winner-full">
				<span class="winner-flag">Winner!!</span>
				<span class="player-name">@User2Name</span>
				<span class="player-points-inline">• PTS: @player2points</span>
			</p>
		}
		else
		{
			<p class="mb-0 @player1Class">
				<span class="player-name">@User1Name</span>
				<span class="player-points-inline">• PTS: @player1points</span>
			</p>
			<p class="mb-0 @player2Css">
				<span class="player-name">@User2Name</span>
				<span class="player-points-inline">• PTS: @player2points</span>
			</p>
		}
	</div>

	@* Form posts which position the user clicked *@
	<div class="othello-board">
		@* Render an 8x8 board with move buttons on empty cells. *@
		@for (int row = 0; row < 8; row++)
		{
			for (int col = 0; col < 8; col++)
			{
				var index = row * 8 + col;
				var cell = @Model[row, col];

				<div class="othello-cell">
					@* Only the active player can submit a move on empty cells. *@
					@if (cell == 0 && playerTurn == currentPlayer)
					{
						<form method="post" asp-controller="Games" asp-action="makeMove">
							<input type="hidden" name="row" value="@row" />
							<input type="hidden" name="col" value="@col" />
							<input type="hidden" name="currentplayer" value="@currentPlayer" />
							<button type="submit" class="othello-cell-button"></button>
						</form>
					}
					else if (cell == 2)
					{
						<!-- White piece -->
						<div class="othello-piece white"></div>
					}
					else if (cell == 1)
					{
						<!-- Black piece -->
						<div class="othello-piece black"></div>
					}
				</div>
			}
		}

	</div>
	@* Show end-of-game action when a winner is determined. *@
	@if (showEndActions)
	{
		<form asp-controller="Games" asp-action="FinishedGame" method="post">
			<button type="submit" class="othello-btn" style="margin-top:1.5rem">
				@Html.AntiForgeryToken()
				Continue
			</button>
		</form>
	}

	@* Show leave action while the game is still active. *@
	@if (!showEndActions)
	{
		<form asp-controller="Games" asp-action="LeaveGame" method="post" class="othello-leave-form">
			@Html.AntiForgeryToken()
			<button type="submit" class="othello-leave-btn">Leave Game</button>
		</form>
	}



</div>
